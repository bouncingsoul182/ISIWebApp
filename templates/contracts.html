<!DOCTYPE html>
<html>
<head>
    <title>Contracts</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" charset="utf8" src="{{ url_for('static', filename='js/datatable.min.js') }}"></script>
</head>
<body>
    {% include 'header.html' %}        
    <div class="search">
            <button id="create-contract-button">Create New Contract</button>
            <button id="upload-clients-button">Upload Contracts</button>
        </div>
    </header>

    <!-- Add Client Upload Modal 
    <div id="add-client-upload-modal" class="modal">
        <div class="modal-content" style="width: 45%; margin-top: 1%;">
            <span class="close">&times;</span>
            <h2>Upload Clients CSV</h2>
            <form action="/upload-clients" method="post" enctype="multipart/form-data" id="upload-clients-form">
                <div class="form-group">
                    <label for="csv_file">Upload Clients CSV File:</label>
                    <input type="file" name="csv_file" id="csv_file" accept=".csv">
                </div>
                <div class="form-group">
                    <input id="upload-clients-button" type="submit" value="Upload CSV" class="button">
                </div>
            </form>
            <a href="/download-client-template" class="btn btn-secondary" download>Download Template</a>
        </div>
    </div> -->
    <!-- Contract Creation Modal -->
    <div id="create-contract-modal" class="modal">
        <div class="modal-content" style="width: 45%; margin-top: 1%;">
            <span class="close">&times;</span>
            <h2>Create New Contract</h2>
            <form action="/create-contract" method="post" id="create-contract-form">
                <div class="form-group">
                    <label for="client_account_number">Client Name:</label>
                    <select name="client_account_number" id="client_account_number" required>
                        {% for client in clients %}
                            <option value="{{ client.account_number }}">{{ client.client_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="equipment">Equipment:</label>
                    <select multiple name="equipment[]" id="equipment">
                        {% for equip in equipment %}
                            <option value="{{ equip.id }}">{{ equip.equipment_number }} - {{ equip.equipment_type }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Additional fields for job type, start/end dates, charge, billing cycle -->

                <input type="submit" value="Create Contract" class="button">
            </form>
        </div>
    </div>
    <!-- Contracts Table -->
    <div style="width: 95%; padding-top: 1%; margin: auto;">
        <table id="contracts-table" style="width: 100%; margin-top: 10px;">
            <thead>
                <tr>
                    <th>Contract ID</th>
                    <th>Client</th>
                    <th>Job Type</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Renewal Date</th>
                    <th>Contract Charge</th>
                    <th>Billing Cycle</th>
                </tr>
            </thead>
            <tbody>
                {% for contract in contracts %}
                <tr class="clickable-row" data-href="{{ url_for('contract_details', contract_id=contract.id) }}">
                    <td>{{ contract.id }}</td>
                    <td>{{ contract.client_id }}</td>
                    <td>{{ contract.job_type }}</td>
                    <td>{{ contract.start_date }}</td>
                    <td>{{ contract.end_date }}</td>
                    <td>{{ contract.renewal_date }}</td>
                    <td>{{ contract.charge }}</td>
                    <td>{{ contract.billing_cycle }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <script>
        $(document).ready(function() {
            // Update equipment list based on selected client
            $('#client_account_number').on('change', function() {
                var accountNumber = $(this).val();
                console.log("Selected Account Number:", accountNumber); // Debugging line
                if (accountNumber) {
                    fetch(`/get-equipment-for-client/${accountNumber}`)
                        .then(response => response.json())
                        .then(data => {
                            var equipmentSelect = $('#equipment');
                            equipmentSelect.empty();
                            data.forEach(function(equip) {
                                equipmentSelect.append(new Option(equip.equipment_number + ' - ' + equip.equipment_type, equip.id));
                            });
                        })
                        .catch(error => console.error('Error:', error));
                } else {
                    alert("No account number selected");
                }
            });

            // Initialize DataTable
            $('#contracts-table').DataTable({
                "paging": true,
                "searching": true,
                "ordering": true
            });

            // Make table rows clickable
            $('#contracts-table').on('click', '.clickable-row', function() {
                window.location.href = $(this).data('href');
            });

            // Event listener for opening and closing the contract creation modal
            $('#create-contract-button').on('click', function() {
                $('#create-contract-modal').show();
            });
            $('.close').on('click', function() {
                $('.modal').hide();
            });

        });
    </script>
</body>
</html>
